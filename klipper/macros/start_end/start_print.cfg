[gcode_macro START_PRINT]
description: Start print
gcode:

    {% set default_bed_temp = 45 %}
    {% set default_nozzle_temp = 200 %}
    {% set default_z_height = 0.3 %}

    {% set start_nozzle_temp_offset = -25 %}
    {% set safe_z_height = 5 %}

    {% set bed_temp = params.BED | default(default_bed_temp) | float %}
    {% set nozzle_temp = params.HOTEND | default(default_nozzle_temp) | float %}
    {% set z_height = params.FIRST_LAYER_Z_HEIGHT | default(default_z_height) | float %}

    {% set start_nozzle_temp = nozzle_temp + start_nozzle_temp_offset %}

    {% set conf_vars = printer["gcode_macro _CONFIGS"] %}
    {% set always_home = conf_vars.always_home_on_print_start %}
    {% set printer_is_homed = printer.toolhead.homed_axes == 'xyz' %}
    {% set prime_nozzle = conf_vars.print_start_prime_nozzle %}
    {% set prime_nozzle_mm = conf_vars.print_start_prime_nozzle_mm | float %}

    {% set delay_bed_temp = conf_vars.delay_nozzle_temp_when_bed_above | float %}
    {% set hold_hotend_until = conf_vars.delay_nozzle_temp_until_bed_within | float %}
    {% set hold_nozzle_temp = conf_vars.hold_nozzle_temp_at | float %}

    SET_CONFIG_VAR VAR=print_bed_temp VAL={bed_temp}
    SET_CONFIG_VAR VAR=print_nozzle_temp VAL={nozzle_temp}
    SET_CONFIG_VAR VAR=print_first_layer_height VAL={z_height}

    G90                                                     ;   Absolute Positioning
    M83                                                     ;   Extruder Relative
    M104 S{start_nozzle_temp}                               ;   Set start nozzle temp
    M140 S{bed_temp}                                        ;   Set final bed temperature 

    {% if always_home or not printer_is_homed %}
        G28                                                 ;   Home
    {% endif %}

    #TODO: If bed temp above threshold, wait until bed is at Temp - X degrees before heating nozzle up fully.

    {% if delay_bed_temp <= bed_temp %}
        {% set wait_temp = bed_temp - hold_hotend_until %}
        M118 Holding hotend at {start_nozzle_temp} until bed warms up to {wait_temp}

        M104 S{hold_nozzle_temp}                            ;   Set nozzle to holding temp
        G1 Z{safe_z_height} F240                            ;   Move Z up a bit
        G1 X2 Y3 F3000                                      ;   Move X and Y over
        M190 S{wait_temp}                                   ;   Wait for bed to reach just under what we want
        M104 S{nozzle_temp}                                 ;   Set hotend to final temperature
    {% else %}

        M104 S{nozzle_temp}                                 ;   Set final nozzle temp
        G1 Z{safe_z_height} F240                            ;   Move Z up a bit
        G1 X2 Y3 F3000                                      ;   Move X and Y over

    {% endif %}
    
    M190 S{bed_temp}                                        ;   Wait for bed to be ready
    M109 S{nozzle_temp}                                     ;   Wait for nozzle to be ready

    {% if prime_nozzle %}
        M117 priming...
        M118 priming Nozzle by {prime_nozzle_mm} mms
        M118 You may need to clean off excess filament
        G1 E{prime_nozzle_mm} F3600                         ;Prime the nozzle
    {% endif %}

    _DRAW_PRIME_LINE Z_HEIGHT={z_height}

