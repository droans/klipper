[gcode_macro SET_FILAMENT_PROPERTIES]
gcode:
    
    {% set max_accel = params.MAX_ACCEL | default(-1) | float %}
    {% set max_speed = params.MAX_SPEED | default(-1) | float %}
    {% set pressure_advance = params.PRESSURE_ADVANCE | default(-1) | float %}
    {% set square_corner_limit = params.SQUARE_CORNER_LIMIT | default(-1) | float %}
    {% set max_accel_to_decel = params.MAX_ACCEL_TO_DECEL | default(-1) | float %}

    {% set retract_amount = params.RETRACTION | default(-1) | float %}
    {% set retract_speed = params.RETRACT_SPEED | default(-1) | float %}
    {% set extra_unretract_amount = params.EXTRA_UNRETRACT_AMOUNT | default(-1) | float %}
    {% set unretract_speed = params.UNRETRACT_SPEED | default(-1) | float %}

    {% set conf_macro = "_CONFIGS" %}

    {% set var_names = {
            "max_accel": "print_max_accel",
            "max_speed": "print_max_speed",
            "pressure_advance": "print_pressure_advance",
            "square_corner_limit": "print_square_corner_limit",
            "max_accel_to_decel": "print_max_accel_to_decel",
            "retract_amount": "print_retract_mm",
            "retract_speed": "print_retract_speed",
            "extra_unretract_amount": "print_extra_unretract_amount",
            "unretract_speed": "print_unretract_speed"
        }
    
    %}

    {% if max_accel != -1 %}
        SET_VELOCITY_LIMIT ACCEL={max_accel}
        M118 Acceleration Limit set to {max_accel}
        SET_CONFIG_VAR VAR={var_names.max_accel} VAL={max_accel}

    {% endif %}

    {% if max_speed != -1 %}
        SET_VELOCITY_LIMIT VELOCITY={max_speed}
        M118 Speed Limit set to {max_speed}
        SET_CONFIG_VAR VAR={var_names.max_speed} VAL={max_speed}

    {% endif %}

    {% if sq_corner_limit != -1 %}
        SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={sq_corner_limit}
        M118 Square Corner Velocity Limit set to {sq_corner_limit}
        SET_GCODE_VARIABLE MACRO={macro_name} VARIABLE={var_names.sqare_corner_limit} VALUE={sq_corner_limit}

    {% endif %}

    {% if decel_limit != -1 %}
        SET_VELOCITY_LIMIT ACCEL_TO_DECEL={decel_limit}
        M118 Accel to Decel Limit set to {decel_limit}
        SET_GCODE_VARIABLE MACRO={macro_name} VARIABLE={var_names.max_decel} VALUE={decel_limit}
    {% endif %}

    {% if retract != -1 %}
        SET_RETRACTION RETRACTION_LENGTH={retract}
        M118 Retraction set to {retract}
        SET_GCODE_VARIABLE MACRO={macro_name} VARIABLE={var_names.retract_amount} VALUE={retract}
    {% endif %}

    {% if press_adv != -1 %}
        SET_PRESSURE_ADVANCE ADVANCE={press_adv}
        M118 Pressure advance adjusted to {press_adv}
        SET_GCODE_VARIABLE MACRO={macro_name} VARIABLE={var_names.pressure_advance} VALUE={press_adv}
    {% endif %}

    {% if retract_speed != -1 %}
        SET_RETRACTION RETRACT_SPEED={retract_speed}
        M118 Setting retract speed to {retract_speed}
        SET_CONFIG_VAR VAR={var_names.retract_speed} VAL={retract_speed}
    {% endif %}

    {% if extra_unretract_amount != -1 %}
        SET_RETRACTION UNRETRACT_EXTRA_LENGTH={extra_unretract_amount}
        M118 Setting extra unretract amount to {extra_unretract_amount}
        SET_CONFIG_VAR VAR={var_names.extra_unretract_amount} VAL={extra_unretract_amount}
    {% endif %}

    {% if unretract_speed != -1 %}
        SET_RETRACTION UNRETRACT_SPEED={unretract_speed}
        M118 Setting unretract speed to {unretract_speed}
        SET_CONFIG_VAR VAR={var_names.unretract_speed} VAL={unretract_speed}
    {% endif %}