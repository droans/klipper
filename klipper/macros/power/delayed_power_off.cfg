[delayed_gcode delayed_printer_off]
initial_duration: 0
gcode:
    {% if printer.idle_timeout.state == "Idle" %}
        {% set conf_vars = printer["gcode_macro _CONFIGS"] %}
        {% set h_temp = printer.extruder.temperature | float %}
        {% set h_temp_max = conf_vars.shutdown_max_hotend_temp | float %}

        {% set b_temp = printer.heater_bed.temperature | float %}
        {% set b_temp_max = conf_vars.shutdown_max_bed_temp | float %}

        {% set shutdown_delay = conf_vars.shutdown_min_delay | float %}
        

        {% if h_temp > h_temp_max %}
            M118 Hotend currently at {h_temp | int } which is above limit of {h_temp_max | int }. Waiting a bit longer before shutting off.
            UPDATE_DELAYED_GCODE ID=delayed_printer_off DURATION={shutdown_delay}

        {% elif b_temp > b_temp_max %}

            M118 Bed currently at {b_temp | int} which is above limit of {b_temp_max | int}. Waiting a bit longer before shutting off.
            UPDATE_DELAYED_GCODE ID=delayed_printer_off DURATION={shutdown_delay}
        
        {% else %}
            POWER_OFF_PRINTER

        {% endif %}

    {% endif %}