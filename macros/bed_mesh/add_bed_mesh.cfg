[gcode_macro ADD_BED_MESH]
description: Generate Bed Mesh. Usage: ADD_BED_MESH [TEMP] [NAME]
gcode: 
	{% set default_bed_temp = printer["gcode_macro _CONFIGS"].bed_mesh.temps.default | float %}
	{% set min_bed_temp = printer["gcode_macro _CONFIGS"].bed_mesh.temps.min | float %}
	{% set max_bed_temp = printer["gcode_macro _CONFIGS"].bed_mesh.temps.max | float %}

	{% set bed_temp = params.TEMP | default(default_bed_temp) | float %}

	{% set mesh_name = params.NAME | default('temp_' + (bed_temp | int | string)) %}

	{% if bed_temp < min_bed_temp %}
		M118 Error: Bed Temp {bed_temp} below minimum {min_bed_temp}
	{% elif bed_temp > max_bed_temp %}
		M118 Error: Bed Temp {bed_temp} above maximum {max_bed_temp}
	{% else %}

		M117 Heating up the bed to {bed_temp}...
		M118 Heating up the bed to {bed_temp}...


		M190 S{ns.temp}

		M117 Homing...
		M118 Homing...

		G28

		M117 Calibrating Mesh...
		M118 Calibrating Mesh...
		BED_MESH_CALIBRATE


		M117 Mesh Calibrated.
		M118 Mesh Calibrated.
		BED_MESH_PROFILE SAVE={mesh_name}

		M117 New profile saved.
		M118 New profile saved as {mesh_name}.
		
		M109 S0

	{% endif %}