[gcode_macro _START_HEATERS]
gcode:    
    
    {% set default_vars = printer['extended_macro _CONFIG_PRINT'].defaults %}
    {% set start_vars = printer['extended_macro _CONFIG_PRINT'].print_start %}

    {% set default_bed_temp = default_vars.bed_temp | default(45) | float %}
    {% set default_nozzle_temp = default_vars.hotend_temp | default(200) | float %}
    
    {% set delay_hotend_temp_offset = start_vars.hotend_offset | default(50) | float %}
    {% set bed_temp_offset = start_vars.delay_hotend_until_bed_within | default(5) | float %}
    {% set wait_for_bed = start_vars.delay_hotend_for_bed_temp %}

    {% set bed_temp = params.BED | default(default_bed_temp) | float %}
    {% set nozzle_temp = params.HOTEND | default(default_nozzle_temp) | float %}
    {% set bed_wait_temp = bed_temp - bed_temp_offset %}
    {% set act_bed_temp = printer.heater_bed.temperature | float %}
    {% set act_nozzle_temp = printer.extruder.temperature | float %}

    {% if wait_for_bed and (act_bed_temp < (bed_temp - bed_temp_offset)) %}
        {% set start_nozzle_temp = nozzle_temp - delay_hotend_temp_offset | float %}
    {% else %}
        {% set start_nozzle_temp = nozzle_temp %}
    {% endif %}

    M104 S{start_nozzle_temp}                               ;   Set start nozzle temp
    M140 S{bed_temp + 10}                                        ;   Set final bed temperature 

[gcode_macro WAIT_FOR_HEATERS]
gcode:
    {% set default_vars = printer['extended_macro _CONFIG_PRINT'].defaults %}
    {% set start_vars = printer['extended_macro _CONFIG_PRINT'].print_start %}

    {% set default_bed_temp = default_vars.bed_temp | float %}
    {% set default_nozzle_temp = default_vars.hotend_temp | float %}
    
    {% set delay_hotend_temp_offset = start_vars.hotend_offset | float %}
    {% set bed_temp_offset = start_vars.delay_hotend_until_bed_within | float %}
    {% set wait_for_bed = start_vars.delay_hotend_for_bed_temp %}

    {% set bed_temp = params.BED | default(default_bed_temp) | float %}
    {% set nozzle_temp = params.HOTEND | default(default_nozzle_temp) | float %}

    {% set mesh_start = params.MESH_START | default(-1)  %}
    {% set mesh_end = params.MESH_END | default(-1)  %}

    {% set act_nozzle_temp = printer.extruder.temperature | float %}



    {% if wait_for_bed %}
        {% set start_nozzle_temp = nozzle_temp - delay_hotend_temp_offset | float %}
        {% set bed_wait_temp = bed_temp - bed_temp_offset %}
    {% else %}
        {% set start_nozzle_temp = nozzle_temp %}
        {% set bed_wait_temp = bed_temp %}
    {% endif %}

    {% if act_nozzle_temp >= start_nozzle_temp %}
        M118 Current nozzle temp above start nozzle temp. Holding at current temp instead
        {% set start_nozzle_temp = act_nozzle_temp %}
    {% endif %}

    M140 S{bed_temp+10}                                        ; Begin bed warmup
    M104 S{start_nozzle_temp}                               ; Begin Nozzle warmup

    G91                                                     ; Absolute Positioning

    {% if start_nozzle_temp != nozzle_temp %}
        {% if printer.heater_bed.temperature | float > bed_wait_temp %}
            M118 Set to hold hotend until bed reaches {bed_wait_temp | int} degrees, but bed already warmed up.
        {% else %}
            M118 Holding hotend at {start_nozzle_temp | int} degrees until bed warms up to {bed_wait_temp | int} degrees.
            TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_wait_temp - 2}
            M190 S{bed_wait_temp}                                   ; Wait for bed to hit wait temp
        {% endif %}
    {% else %}
        M118 Not holding for bed because nozzle already fully heated.
    {% endif %}
    
    

    {% if start_nozzle_temp != nozzle_temp %}
        M118 Bed warmed up, setting nozzle to full temperature
    {% endif %}


    M190 M{bed_temp}

    {% if mesh_start != -1 %}
        M118 Will perform mesh prior to warming nozzle up fully. 
        M190 S{bed_temp}
        PRINT_AREA_BED_MESH AREA_START={mesh_start} AREA_END={mesh_end}            
    {% endif %}

    M104 S{nozzle_temp}
    M109 S{nozzle_temp}
    M190 S{bed_temp}