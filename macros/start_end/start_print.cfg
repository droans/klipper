[gcode_macro START_PRINT]
description: Start Print
gcode:
    {% set start_vars = printer['extended_macro _CONFIG_PRINT'].print_start %}
    {% set default_vars = printer['extended_macro _CONFIG_PRINT'].defaults %}

    {% set default_z_height = printer['extended_macro _CONFIG_PRINT'].defaults.z_height %}
	{% set default_enable_prime = start_vars.enable_prime_line %}
	{% set default_enable_purge = start_vars.purge_nozzle %}
    {% set default_nozzle_temp = default_vars.purge_nozzle %}
    {% set default_bed_temp = default_vars.purge_nozzle %}

    {% set glob_vars = printer['extended_macro _CONFIG_GLOBAL'] %}
    {% set falsey = glob_vars.falsey_values %}
    {% set cur_act = glob_vars.current_action %}

    {% set bed_temp = params.BED | default(default_bed_temp) | float %}
    {% set nozzle_temp = params.HOTEND | default(default_nozzle_temp) | float %}
    {% set z_height = params.FIRST_LAYER_Z_HEIGHT | default(default_z_height) | float %}
    {% set mesh_start = params.MESH_START | default('0,0')  %}
    {% set mesh_end = params.MESH_END | default('0,0')  %}
    {% set total_layers = params.LAYERS | default(0) | int %}

	{% set enable_purge = (params.PURGE | default(default_enable_purge)) not in falsey %}
    {% set enable_prime = (params.PRIME_NOZZLE | default(default_enable_prime)) not in falsey %}
    {% set enable_mesh = (params.MESH_ENABLE | default(-1)) not in falsey %}

    _CONFIG_GLOBAL VAR=current_action VAL="start_print"

    _CONFIG_PRINT VAR=current_print KEY=bed_temp VAL={bed_temp}
    _CONFIG_PRINT VAR=current_print KEY=nozzle_temp VAL={nozzle_temp}
    _CONFIG_PRINT VAR=current_print KEY=first_layer_height VAL={z_height}
    _CONFIG_PRINT VAR=current_print KEY=purge_nozzle VAL={enable_purge}
    _CONFIG_PRINT VAR=current_print KEY=prime_nozzle VAL={enable_prime}
    _CONFIG_PRINT VAR=current_print KEY=mesh_start VAL={mesh_start}
    _CONFIG_PRINT VAR=current_print KEY=mesh_end VAL={mesh_end}
    _CONFIG_PRINT VAR=current_print KEY=total_layers VAL={total_layers}
    
    _START_PRINT


[gcode_macro _START_PRINT]
gcode:
    {% set macros = printer['extended_macro _CONFIG_PRINT'].print_start_commands %}

    {% for macro in macros %}
        M118 {macro}
        {macro}
    {% endfor %}

[gcode_macro _PRINT_EVAL_MESH]
gcode:
    {% set vars = printer['extended_macro _CONFIG_PRINT'].current_print %}

    {% set falsey = printer['gcode_macro _CONFIGS'].falsey_values %}

    {% set enable = (vars.enable_mesh not in falsey) %}
    {% set mesh_begin = vars.mesh_start %}
    {% set mesh_end = vars.mesh_end %}
    {% set bed_temp = vars.bed_temp | float %}


    {% if enable %}
        M118 Beginning mesh.
        M190 M{bed_temp}
        BED_MESH_CALIBRATE
    {% endif %}
