[extended_macro SETUP_PRINT]
description: Setup Print
gcode:
    {% set start_vars = printer['extended_macro _CONFIG_PRINT'].print_start %}
    {% set default_vars = printer['extended_macro _CONFIG_PRINT'].defaults %}

    {% set z_height = params.FIRST_LAYER_Z_HEIGHT | default(default_vars.z_height) | float %}
    _CONFIG_PRINT VAR=current_print KEY=first_layer_height VAL={z_height}

    {% set enable_prime = eval(params.PRIME_NOZZLE | default(start_vars.enable_prime_line)) %}
    _CONFIG_PRINT VAR=current_print KEY=prime_nozzle VAL={enable_prime}

    {% set enable_purge = eval(params.PURGE | default(start_vars.purge_nozzle)) %}
    _CONFIG_PRINT VAR=current_print KEY=purge_nozzle VAL={enable_purge}
  
    {% set nozzle_temp = params.HOTEND | default(default_vars.hotend_temp) | float %}
    _CONFIG_PRINT VAR=current_print KEY=nozzle_temp VAL={nozzle_temp}
 
    {% set bed_temp = params.BED | default(default_vars.bed_temp) | float %}
    _CONFIG_PRINT VAR=current_print KEY=bed_temp VAL={bed_temp}

    {% set enable_mesh = eval(params.ENABLE_MESH | default(default_vars.enable_mesh)) %}
    _CONFIG_PRINT VAR=current_print KEY=enable_mesh VAL={enable_mesh}
    
    {% set mesh_profile = params.MESH_PROFILE | default(default_vars.mesh_profile) %}
    _CONFIG_PRINT VAR=current_print KEY=mesh_profile VAL={mesh_profile}

    {% set generate_mesh = eval(params.GENERATE_MESH | default(default_vars.generate_mesh)) %}
    _CONFIG_PRINT VAR=current_print KEY=generate_mesh VAL={generate_mesh}

    {% set mesh_start = params.MESH_START | default('0,0')  %}
    {% set mesh_end = params.MESH_END | default('0,0')  %}
    _CONFIG_PRINT VAR=current_print KEY=mesh_start VAL={mesh_start}
    _CONFIG_PRINT VAR=current_print KEY=mesh_end VAL={mesh_end}

    {% set total_layers = params.LAYERS | default(0) | int %}
    _CONFIG_PRINT VAR=current_print KEY=total_layers VAL={total_layers}
    
    _SETUP_PRINT


[gcode_macro _SETUP_PRINT]
gcode:
    {% set commands = printer['extended_macro _CONFIG_PRINT'].print_setup_commands %}

    {% for command in commands %}
        {command}
    {% endfor %}

[extended_macro _PRINT_EVAL_MESH]
gcode:
    {% set vars = printer['extended_macro _CONFIG_PRINT'].current_print %}

    {% set generate_mesh = vars.generate_mesh %}
    {% set mesh_begin = vars.mesh_start %}
    {% set mesh_end = vars.mesh_end %}
    {% set bed_temp = vars.bed_temp | float %}

    {% set enable_mesh = vars.enable_mesh %}
    {% set mesh_profile = vars.mesh_profile %}

    {% if generate_mesh == true %}
        M118 Calibrating new mesh
        M190 B{bed_temp}
        BED_MESH_CALIBRATE
    {% elif enable_mesh == true %}
        {% if (mesh_profile | length ) %}
            M118 Loading mesh {mesh_profile}
            BED_MESH_PROFILE LOAD={mesh_profile}
        {% endif %}
    {% endif %}

[gcode_macro START_PRINT]
gcode:
    {% set commands = printer['extended_macro _CONFIG_PRINT'].print_start_commands %}

    {% for command in commands %}
        {command}
    {% endfor %}