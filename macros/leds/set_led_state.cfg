[gcode_macro SET_LED_STATE]
gcode:
    {% set led_vars = printer['gcode_macro _CONFIG_LEDS'] %}

    {% set led_state = (params.values() | list)[0] | lower %}

    {% set led_states = led_vars.state_colors %}
    {% set led_colors = led_vars.colors %}


    {% if led_state in led_states %}
        {% set state_color = led_states[led_state] %}
    {% else %}
        {% set state_color = led_states.default %}
        M118 LED State {led_state} not found in LED States {led_states.keys()}!
    {% endif %}


    {% if state_color in led_colors %}
        {% set l = led_colors[state_color] %}
    {% else %}
        {% set l = led_colors.default %}
        M118 LED Color Scheme {state_color} not found in LED Colors {led_colors.keys()}!
    {% endif %}

    {% set strips = l.strip_name %}
    {% set red = l.red | float %}
    {% set green = l.green | float %}
    {% set blue = l.blue | float %}
    {% set white = l.white | float %}
    {% set index = l.index | int %}
    {% set transmit = l.transmit | int %}

    {% if strips is string %}
        {% set strips = [strips] %}
    {% endif %}
    
    {% for strip in strips %}
        {% if index == -1 %}
            SET_LED LED={strip} RED={red} GREEN={green} BLUE={blue} WHITE={white} TRANSMIT={transmit}
        {% else %}
            SET_LED LED={strip} RED={red} GREEN={green} BLUE={blue} WHITE={white} TRANSMIT={transmit} INDEX={index}
        {% endif %}
    {% endfor %}

    {% if 'delayed_return' in l %}
        {% set return_macro = l.delayed_return.macro %}
        {% set return_delay = l.delayed_return.delay | int %}

        UPDATE_DELAYED_GCODE ID={return_macro} DURATION={return_delay}
    {% endif %}